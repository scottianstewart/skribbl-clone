<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Louvre (basically)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Nunito:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="gallery.css" />
  </head>
  <body>
    <nav class="gallery-nav">
      <a href="/" class="nav-back">â† Play</a>

      <div class="nav-controls">
        <div id="gallery-volume-control">
          <span id="gallery-volume-icon">ğŸ”Š</span>
          <input
            type="range"
            id="gallery-volume-slider"
            min="0"
            max="1"
            step="0.05"
            value="0.2"
          />
        </div>
        <button id="music-btn" class="music-btn" title="Toggle music">
          ğŸµ
        </button>
      </div>
    </nav>

    <header class="gallery-header">
      <h1>The Louvre <span class="small">(basically)</span></h1>
      <p class="gallery-subtitle">Masterworks from the ages</p>
    </header>

    <div id="filter-bar" class="filter-bar hidden"></div>

    <main id="gallery-main">
      <div id="loading-state" class="status-message">
        <span class="loading-dots">Loading masterworks</span>
      </div>
      <div id="empty-state" class="status-message hidden">
        <p>The gallery awaits its first masterwork.</p>
        <a href="/" class="play-link">Play a game to fill it â†’</a>
      </div>
      <div id="paintings-grid" class="paintings-grid"></div>
      <div id="load-more-row" class="load-more-row hidden">
        <button id="btn-load-more" class="btn-load-more">
          Load more masterworks
        </button>
      </div>
    </main>

    <!-- Lightbox -->
    <div
      id="lightbox"
      class="lightbox hidden"
      role="dialog"
      aria-modal="true"
      aria-label="Painting detail"
    >
      <div class="lightbox-backdrop"></div>
      <div class="lightbox-content">
        <button class="lightbox-close" aria-label="Close">âœ•</button>
        <div class="lightbox-frame-area">
          <img class="lightbox-art" src="" alt="" />
          <img
            class="lightbox-frame"
            src="/frame.png"
            alt=""
            aria-hidden="true"
          />
        </div>
        <div class="lightbox-plaque">
          <div class="plaque-divider"></div>
          <div class="plaque-word" id="lb-word"></div>
          <div class="plaque-meta" id="lb-meta"></div>
          <div class="plaque-date" id="lb-date"></div>
        </div>
      </div>
    </div>

    <!-- Drop a baroque MP3 at public/sounds/baroque.mp3 to enable music.
       Free public-domain baroque recordings are available at musopen.org -->
    <audio id="bg-music" loop autoplay>
      <source src="/sounds/baroque.mp3" type="audio/mpeg" />
    </audio>

    <script>
      const musicBtn = document.getElementById("music-btn");
      const bgMusic = document.getElementById("bg-music");
      const grid = document.getElementById("paintings-grid");
      const loadingEl = document.getElementById("loading-state");
      const emptyEl = document.getElementById("empty-state");
      const loadMoreRow = document.getElementById("load-more-row");
      const btnLoadMore = document.getElementById("btn-load-more");
      const filterBar = document.getElementById("filter-bar");
      const galleryVolumeSlider = document.getElementById(
        "gallery-volume-slider",
      );
      const galleryVolumeIcon = document.getElementById("gallery-volume-icon");

      // â”€â”€ Volume (shared localStorage key with game page) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let galleryVolume = parseFloat(
        localStorage.getItem("masterVolume") ?? "0.7",
      );
      bgMusic.volume = galleryVolume;
      galleryVolumeSlider.value = galleryVolume;
      updateGalleryVolumeIcon(galleryVolume);

      galleryVolumeSlider.addEventListener("input", () => {
        galleryVolume = parseFloat(galleryVolumeSlider.value);
        bgMusic.volume = galleryVolume;
        localStorage.setItem("masterVolume", galleryVolume);
        updateGalleryVolumeIcon(galleryVolume);
      });

      galleryVolumeIcon.addEventListener("click", () => {
        galleryVolume =
          galleryVolume > 0
            ? 0
            : parseFloat(localStorage.getItem("masterVolume") || "0.7");
        bgMusic.volume = galleryVolume;
        galleryVolumeSlider.value = galleryVolume;
        updateGalleryVolumeIcon(galleryVolume);
      });

      function updateGalleryVolumeIcon(vol) {
        if (vol === 0) galleryVolumeIcon.textContent = "ğŸ”‡";
        else if (vol < 0.4) galleryVolumeIcon.textContent = "ğŸ”‰";
        else galleryVolumeIcon.textContent = "ğŸ”Š";
      }

      let musicPlaying = false;
      let offset = 0;
      const LIMIT = 48;
      let totalItems = 0;
      let activeDrawer = null;

      // â”€â”€ Music toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      musicBtn.addEventListener("click", () => {
        if (musicPlaying) {
          bgMusic.pause();
          musicBtn.textContent = "ğŸµ";
          musicBtn.classList.remove("playing");
        } else {
          bgMusic.play().catch(() => {});
          musicBtn.textContent = "â¸";
          musicBtn.classList.add("playing");
        }
        musicPlaying = !musicPlaying;
      });

      // Attempt immediate autoplay (may be blocked by browser policy)
      bgMusic
        .play()
        .then(() => {
          musicPlaying = true;
          musicBtn.textContent = "â¸";
          musicBtn.classList.add("playing");
        })
        .catch(() => {});

      // Fallback: autoplay on first user interaction anywhere on the page
      document.addEventListener(
        "click",
        () => {
          if (!musicPlaying && bgMusic.src && !bgMusic.error) {
            bgMusic
              .play()
              .then(() => {
                musicPlaying = true;
                musicBtn.textContent = "â¸";
                musicBtn.classList.add("playing");
              })
              .catch(() => {});
          }
        },
        { once: true },
      );

      // â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const lightbox = document.getElementById("lightbox");
      const lbArt = lightbox.querySelector(".lightbox-art");
      const lbWord = document.getElementById("lb-word");
      const lbMeta = document.getElementById("lb-meta");
      const lbDate = document.getElementById("lb-date");
      const lbClose = lightbox.querySelector(".lightbox-close");
      const lbBackdrop = lightbox.querySelector(".lightbox-backdrop");

      function openLightbox(item) {
        lbArt.src = `/api/gallery/${item.id}/image`;
        lbArt.alt = item.word;
        lbWord.textContent = item.word;
        lbMeta.innerHTML = `by <em>${escHtml(item.drawer)}</em> Â· Round ${item.round}`;
        lbDate.textContent = formatDate(item.played_at);
        lightbox.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        lbClose.focus();
      }

      function closeLightbox() {
        lightbox.classList.add("hidden");
        document.body.style.overflow = "";
      }

      lbClose.addEventListener("click", closeLightbox);
      lbBackdrop.addEventListener("click", closeLightbox);
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !lightbox.classList.contains("hidden")) {
          closeLightbox();
        }
      });

      // â”€â”€ Painting card builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function escHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function formatDate(str) {
        const d = new Date(str + "Z");
        return d.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function createPainting(item) {
        const wrapper = document.createElement("div");
        wrapper.className = "painting-wrapper";

        wrapper.innerHTML = `
        <div>
        <div class="frame-inner">
          <div class="painting-canvas">
            <img
              src="/api/gallery/${item.id}/image"
              alt="${escHtml(item.word)}"
              class="art-img"
            />
            <img class="frame-overlay" src="/frame.png" alt="" aria-hidden="true">
          </div>
        </div>
        <div class="painting-plaque">
            <div class="plaque-divider"></div>
            <div class="plaque-word">${escHtml(item.word)}</div>
            <div class="plaque-meta">by <em>${escHtml(item.drawer)}</em> Â· Round ${item.round}</div>
            <div class="plaque-date">${formatDate(item.played_at)}</div>
          </div>
        </div>
      `;

        wrapper.addEventListener("click", () => openLightbox(item));
        return wrapper;
      }

      // â”€â”€ Drawer filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadDrawers() {
        try {
          const res = await fetch("/api/gallery/drawers");
          const { drawers } = await res.json();
          if (drawers.length < 2) return;

          filterBar.classList.remove("hidden");
          filterBar.innerHTML = "";

          const allBtn = document.createElement("button");
          allBtn.className = "filter-pill active";
          allBtn.textContent = "All artists";
          allBtn.addEventListener("click", () => setFilter(null));
          filterBar.appendChild(allBtn);

          drawers.forEach((name) => {
            const btn = document.createElement("button");
            btn.className = "filter-pill";
            btn.textContent = name;
            btn.addEventListener("click", () => setFilter(name));
            filterBar.appendChild(btn);
          });
        } catch (_) {}
      }

      function setFilter(drawer) {
        activeDrawer = drawer;
        offset = 0;
        grid.innerHTML = "";
        loadMoreRow.classList.add("hidden");
        loadingEl.classList.remove("hidden");
        emptyEl.classList.add("hidden");

        filterBar.querySelectorAll(".filter-pill").forEach((btn) => {
          btn.classList.toggle(
            "active",
            drawer === null
              ? btn.textContent === "All artists"
              : btn.textContent === drawer,
          );
        });

        loadItems();
      }

      // â”€â”€ Fetch & render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadItems() {
        try {
          const url = activeDrawer
            ? `/api/gallery?limit=${LIMIT}&offset=${offset}&drawer=${encodeURIComponent(activeDrawer)}`
            : `/api/gallery?limit=${LIMIT}&offset=${offset}`;
          const res = await fetch(url);
          const data = await res.json();
          totalItems = data.total;

          loadingEl.classList.add("hidden");

          if (data.total === 0) {
            emptyEl.classList.remove("hidden");
            return;
          }

          const frag = document.createDocumentFragment();
          data.items.forEach((item) => frag.appendChild(createPainting(item)));
          grid.appendChild(frag);

          offset += data.items.length;
          if (offset < totalItems) {
            loadMoreRow.classList.remove("hidden");
          } else {
            loadMoreRow.classList.add("hidden");
          }
        } catch (err) {
          loadingEl.textContent = "Could not load the gallery.";
        }
      }

      btnLoadMore.addEventListener("click", async () => {
        btnLoadMore.disabled = true;
        btnLoadMore.textContent = "Loadingâ€¦";
        await loadItems();
        btnLoadMore.disabled = false;
        btnLoadMore.textContent = "Load more masterworks";
      });

      loadItems();
      loadDrawers();
    </script>
  </body>
</html>
